{% load static %}
<head>
    <link rel="stylesheet" href="{% static 'css/comment.css' %}{{ version_query }}">
</head>
<div class="comment-wrapper hidden" data-bind="comment_section">
    {% load mptt_tags %}
    {% if request.user.is_authenticated %}
    <div class="comment-dialog deepth-0">
        <div class="comment-avt">
            <a href="/user/{{ request.user.username }}">
                <img src="{{ request.user.profile.avatar }}" alt="avatar" class="comment-img">
            </a>
        </div>
        <div class="box-comment">
            <textarea class="comment-editor" placeholder="Viết bình luận" onfocus="ediorFocusHandler(this)"></textarea>
            <div class="comment-button-group">
                <button type="button" class="ico-btn comment-button-media"></button>
                <div class="space"></div>
                <button type="button" class="ico-btn comment-button-submit"
                 onclick="postCommentHandler(this)"
                >
                </button>
            </div>
        </div>
    </div>
    {% endif %}
    <ul class="comment-list" comment-id="-1">
        {% recursetree comments %}
        <li>
            <div class="comment-container deepth-{{ node.deepth}}"
                data-id="{{ node.id }}" data-parent="{{ node.parent.id }}" data-deepth="{{ node.deepth }}"
                data-time="{{ node.created_on }}" data-username="{{ node.author.user.username }}"
                data-display-name="{{ node.author.display_name }}" data-avatar="{{ node.author.avatar }}"
                data-content="{{ node.content }}"
            >
            </div>
            {% if not node.is_leaf_node %}
            <ul class="comment-list" comment-id="{{ node.id }}">{{ children }}</ul>
            {% else %}
            <ul></ul>
            {% endif %}
            <div class="reply-comment-box" comment-id="{{ node.id }}"></div>
        </li>
        {% endrecursetree %}
    </ul>
</div>
<script>
    function $(className){
        return [...document.getElementsByClassName(className)];
    }
    function zpad(n) {
		if (n < 10) return '0' + n;
		return n;
	}
    let now = new Date();
    function convertTime(TimeString){
        const arr = TimeString.trim().split(/[\s\D]+/g).map(e => Number(e));
        const commentTime = new Date(Date.UTC(arr[0], arr[1] - 1, arr[2], arr[3], arr[4], arr[5]));
        let delta = Math.abs(now - commentTime)/1000;
        let days = Math.floor(delta / 86400);
        delta -= days * 86400;

        let hours = Math.floor(delta / 3600) % 24;
        delta -= hours * 3600;

        let minutes = Math.floor(delta / 60) % 60;
        delta -= minutes * 60;
        let seconds = parseInt(delta % 60);

        if (days >= 7) {
            return `${zpad(commentTime.getDate())}-${zpad(commentTime.getMonth() + 1)}-${commentTime.getFullYear()}`;
        }
        else if (days < 7 && days > 0) {
            return`${days} ngày trước`;
        }
        else if (hours > 0) {
            return `${hours} giờ trước`;
        }
        else if (minutes > 0) {
            return `${minutes} phút trước`;
        }
        else if (seconds > 0) {
            return`${seconds} giây trước`;
        }
        return TimeString;
    }
</script>
<script type="text/javascript">
    const wrapper = document.querySelector(".comment-wrapper[data-bind='comment_section'] > ul");
    wrapper.append(...Array.from(wrapper.childNodes).reverse());
    function renderComment(ele){
        const id = ele.getAttribute('data-id');
        const parent = ele.getAttribute('data-parent');
        const time = ele.getAttribute('data-time');
        const deepth = ele.getAttribute('data-deepth');
        const _username = ele.getAttribute('data-username');
        const display_name = ele.getAttribute('data-display-name');
        const avatar = ele.getAttribute('data-avatar');
        const content = ele.getAttribute('data-content');
        commentHTML = `
        <div class="comment-avt">
            <a href="/user/${_username}">
                <img src="${avatar}" alt="avatar" class="comment-img">
            </a>
        </div>
        <div class="comment-content">
            <span class="comment-username">${display_name}</span>
            <p>${content}</p>
            ${is_authenticated
                ?
                `
                <div class="comment-bottom">
                    <button class="comment-reply" parent="${parent}" comment-id="${id}" 
                        deepth="${deepth}" username="${_username}" 
                        display-name="${display_name}" onclick="replyHandler(this)"
                    >
                        Trả lời
                    </button>
                    <span class="time">${convertTime(time)}</span>
                    <div class="more">
                        <button class="ico-btn more-btn"
                            onclick="this.nextElementSibling.classList.toggle('hidden'); this.nextElementSibling.focus()"
                        >
                        </button>
                        <button class="more-menu hidden" onblur="this.classList.add('hidden')">
                            ${
                                username === _username
                                ?
                                    `
                                    <div class="more-item" comment-id="${id}" onclick="deleteCommentHandler(this)">Xoá</div>
                                    `       
                                : ''
                            }
                            <div class="more-item" onclick="this.parentElement.classList.add('hidden')">Báo cáo</div>
                        </button>
                    </div>
                </div>
                `
                : ''
            }
        </div>
        `
        ele.innerHTML = commentHTML;
    }
    $("comment-container").forEach(ele => renderComment(ele));

    const article = "{{ article }}";

    function ediorFocusHandler(ele){
        ele.addEventListener('keydown', e => {
            e.stopImmediatePropagation();
        });
    }
    function replyHandler(ele){
        const parent = ele.getAttribute('parent');
        let deepth = Number(ele.getAttribute('deepth'));
        let commentId = ele.getAttribute('comment-id');
        let container = document.querySelector(`.reply-comment-box[comment-id="${commentId}"]`);
        if(deepth === 2){
            container = document.querySelector(`.reply-comment-box[comment-id="${parent}"]`);
            commentId = parent;
            deepth = 1;
        }
        const username = ele.getAttribute('username');
        const display_name = ele.getAttribute('display-name');
        replyHTML = `
        <div class="comment-dialog deepth-${deepth+1}">
            <div class="comment-avt">
                <a href="/user/{{ request.user.username }}">
                    <img src="{{ request.user.profile.avatar }}" alt="avatar" class="comment-img">
                </a>
            </div>
            <div class="box-comment">
                <textarea class="comment-editor" placeholder="Đang trả lời ${display_name}" onfocus="ediorFocusHandler(this)"></textarea>
                <div class="comment-button-group">
                    <button type="button" class="ico-btn comment-button-media"></button>
                    <div class="space"></div>
                    <button type="button" class="ico-btn comment-button-submit"
                        mention="${username}" parent=${commentId}
                        onclick="postCommentHandler(this)"
                    >
                        <i class="fa-solid fa-comment"></i>
                    </button>
                </div>
            </div>
        </div>
        `;
        container.innerHTML = replyHTML;
        container.scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
    }

    function postCommentHandler(ele){
        const content = ele.parentElement.previousElementSibling.value;
        if(!content) return;
        ele.parentElement.previousElementSibling.value = '';
        const mention = ele.getAttribute("mention") || '';
        const parent = ele.getAttribute("parent") || '-1';
        const formBody = new FormData();
        formBody.append('article', article);
        formBody.append('mention', mention);
        formBody.append('parent', parent);
        formBody.append('content', content);
        formBody.append('csrfmiddlewaretoken', "{{ csrf_token }}");
        replyBox = document.querySelector(`.reply-comment-box[comment-id="${parent}"]`);
        if(replyBox) replyBox.innerHTML = '';
        fetch("/api/comment/",{
            method: "POST",
            body: formBody,
        });
    }

    function deleteCommentHandler(ele){
        commentId = ele.getAttribute('comment-id');
        container = document.querySelector(`.comment-container[data-id='${commentId}']`).parentElement;
        const formBody = new FormData();
        formBody.append('id', commentId);
        formBody.append('csrfmiddlewaretoken', "{{ csrf_token }}");
        fetch('/api/comment/delete/',{
            method: 'POST',
            body: formBody,
        }).then(res => {
            if(res.ok){
                container.remove();
            }
        });
    }
</script>
<script src="{% static 'js/socket/comment.js' %}{{ version_query }}"></script>